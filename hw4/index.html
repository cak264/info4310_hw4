<html>
    <head>
        <h3>Cameron Kull, cak264 & Marie Williams, mcw242</h3>
        <script src="https://d3js.org/d3.v7.min.js"></script>

        <style>
            .gridlines line {
              stroke: #bbb;
            }

            .gridlines .domain {
              stroke: none;
            }

        </style>
    </head>
    <body>
        <div id="day_of_week_container">
            <svg id="day_of_week_svg" height="600" width="600"></svg>
            <svg id="day_of_week_svg2" height="600" width="600"></svg>
        </div>

        <svg id="linechart" height="600" width="800"></svg>

        <script>

            // Day of week counts histogram
            const histogram = d3.select("#day_of_week_svg");
            const width=histogram.attr("width");
            const height=histogram.attr("height");
            const margins={top: 10, right: 10, bottom: 50, left: 50};
            const chartWidth = width - margins.left - margins.right;
            const chartHeight = height - margins.top - margins.bottom;

            // Day of week proportion histogram
            const propHistogram = d3.select("#day_of_week_svg2");

            // Line chart
            const linechart = d3.select("#linechart");
            const svg_width = linechart.attr("width");
            const svg_height= linechart.attr("height");
            const lc_margins={top: 10, right: 10, bottom: 50, left: 50};
            const lchartWidth = svg_width - lc_margins.left - lc_margins.right;
            const lchartHeight = svg_height - lc_margins.top - lc_margins.bottom;

            // Data
            let requestData = async function(){
                let births = await d3.csv("US_births_1994-2014.csv", d3.autoType);
                console.log(births);

                let histArea=histogram.append("g")
                                .attr("class", "histArea")
                                .attr('transform', `translate(${margins.left},${margins.top})`);

                let propHistArea=propHistogram.append("g")
                                .attr("class", "propHistArea")
                                .attr('transform', `translate(${margins.left},${margins.top})`);

                // selecting just the 13ths
                let thirteenths = births.filter(b=> b.date_of_month==13);
                console.log(thirteenths);
                let nonThirteenths = births.filter(b=> b.date_of_month!=13);
                console.log(nonThirteenths);

                // dictionary of avgs per day of week
                let bin = d3.bin().value(d=> d.day_of_week)
                                  .thresholds([1,2,3,4,5,6,7]);
                //let dowBins = bin(thirteenths);
                //console.log(dowBins);
                let dowConverter = d3.scaleOrdinal().domain([1,2,3,4,5,6,7]).range(["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]);

                function dowDict(data){
                    // break the data down into bins, separating day of week
                    let dowBins = bin(data);
                    // create a dictionary holding the average births for each day of the week
                    let dowDict = {};
                    let sum = 0;
                    dowBins.forEach(bin =>{

                        bin.forEach(value =>{
                            sum+=value.births;
                        })
                        dowDict[dowConverter(bin.x0)]=Math.floor(sum/bin.length);
                        sum=0;
                    })
                    return dowDict;
                };

                let thirteenthsDict = dowDict(thirteenths);
                console.log(thirteenthsDict);
                let nonThirteenthsDict = dowDict(nonThirteenths);
                console.log(nonThirteenthsDict);

                let propDict = {};
                for (let key in thirteenthsDict){
                    propDict[key] = thirteenthsDict[key]/nonThirteenthsDict[key];
                }
                console.log(propDict);

                let histXScale = d3.scaleBand().domain(Object.keys(thirteenthsDict)).range([0,chartWidth]);
                let histYScale = d3.scaleLinear().domain([Math.min(...Object.values(thirteenthsDict))-1000, Math.max(...Object.values(thirteenthsDict))+1000]).range([chartHeight, 0]);
                let propHistYScale = d3.scaleLinear().domain([0.936, 1.006]).range([chartHeight, 0]);

                function createAxes(yScale, graph, title){
                    let leftAxis = d3.axisLeft(yScale)
                                     .ticks(7);
                    graph.append('g')
                        .attr('transform',`translate(${margins.left-10},${margins.top})`)
                        .call(leftAxis);

                    let leftGridlines = d3.axisLeft(yScale)
                                        .tickSize(-chartWidth-10)
                                        .ticks(7)
                                        .tickFormat('');
                    graph.append('g')
                        .attr('class', 'gridlines')
                        .attr('transform',`translate(${margins.left-10},${margins.top})`)
                        .call(leftGridlines);

                    let bottomAxis = d3.axisBottom(histXScale);
                    graph.append('g')
                        .attr('transform',`translate(${margins.left},${chartHeight+margins.top+10})`)
                        .call(bottomAxis);

                    // axis labels and titles
                    graph.append('text')
                        .text(title)
                        .attr("class", "title")
                        .attr('x', 320)
                        .attr('y', 10)
                        .style('font-size', 20)
                        .style('font-weight', 'bold')
                        .style("text-anchor", "middle")
                        .style("alignment-baseline", "central");
                };

                createAxes(histYScale, histogram, "Average Birth Counts on the 13th, 1994-2014");
                createAxes(propHistYScale, propHistogram, "Proportion of Births on the 13th to Births on All Other Dates");




                // add bars

                histArea.selectAll("rect.thirteen").data(Object.entries(thirteenthsDict))
                        .join("rect")
                        .attr("class", 'thirteen')
                        .attr("x", d=> histXScale(d[0]))
                        .attr("y", d=> histYScale(d[1]))
                        .attr("width", histXScale.bandwidth())
                        .attr("height", d=> chartHeight - histYScale(d[1]))
                        .attr("fill", function(d){
                            if (d[0] == "Friday"){return "#d62f2f"}
                            else{return "#4a4444"}
                        });

                histArea.raise();

                propHistArea.selectAll("rect.proportion").data(Object.entries(propDict))
                        .join("rect")
                        .attr("class", 'proportion')
                        .attr("x", d=> histXScale(d[0]))
                        .attr("y", d=> propHistYScale(d[1]))
                        .attr("width", histXScale.bandwidth())
                        .attr("height", d=> chartHeight - propHistYScale(d[1]))
                        .attr("fill", function(d){
                            if (d[0] == "Friday"){return "#d62f2f"}
                            else{return "#4a4444"}
                        });

                propHistArea.raise();


                // line chart
                let lChartArea = linechart.append("g")
                                // .attr("class", "linecArea")
                                .attr('transform', `translate(${lc_margins.left},${lc_margins.top})`);

                function drawLineChart(year){
                    const dataYear = births.filter(d => d.year === year);

                    dataYear.forEach(d => {
                        d.date = new Date(d.year, d.month-1, d.date_of_month);
                    });

                    const averageBirths = d3.mean(dataYear, d => d.births);

                    const lcxScale = d3.scaleTime().domain(d3.extent(dataYear, d => d.date)).range([0, lchartWidth]);
                    const lcyScale = d3.scaleLinear().domain([d3.min(dataYear, d => d.births) - averageBirths, d3.max(dataYear, d => d.births) - averageBirths]).range([lchartHeight, 0]);


                    const line = d3.line()
                        .x(d => lcxScale(d.date))
                        .y(d => lcyScale(d.births - averageBirths));

                    const lcxAxis = d3.axisBottom(lcxScale)
                        .tickFormat(d3.timeFormat("%b"));
                    linechart.append('g')
                        .attr('transform', `translate(${lc_margins.left},${lchartHeight + lc_margins.top+20})`)
                        .call(lcxAxis);

                    const lcyAxis = d3.axisLeft(lcyScale)
                        .tickFormat(function(d) {
                            if (d === 0) {
                                return 'Avg';
                            } else if (d>0) {
                                return '+' + d;
                            } else {
                                return d;
                            }
                        });
                    linechart.append('g')
                        .attr('transform', `translate(${lc_margins.left-10},${lc_margins.top})`)
                        .call(lcyAxis);

                    let lcleftGridlines = d3.axisLeft(lcyScale)
                                        .tickSize(-lchartWidth-10)
                                        .tickFormat('');
                    lChartArea.append('g')
                        .attr('class', 'gridlines')
                        .attr('transform',`translate(${lc_margins.left-60}, 0)`)
                        .call(lcleftGridlines);

                    lChartArea.append("line")
                        .attr("class", "average-line")
                        .attr("x1", lc_margins.left-60) //-60
                        .attr("y1", lcyScale(0) + lc_margins.top-10)
                        .attr("x2", lc_margins.left + lchartWidth)
                        .attr("y2", lcyScale(0) + lc_margins.top-10)
                        .style("stroke", "#d62f2f")
                        .style("stroke-width", 2);


                    lChartArea.append("path")
                        .datum(dataYear)
                        .attr("class", "line-chart")
                        .attr("fill", "none")
                        .attr("stroke", "#4a4444")
                        .attr("stroke-width", 1.5)
                        .attr("d", line);

                    // hovering
                    let circles = lChartArea.selectAll("circle").data(dataYear)
                        .join("circle")
                        .attr("class", "point")
                        .attr("cx", d => lcxScale(d.date))
                        .attr("cy", d => lcyScale(d.births)+800)
                        .attr("r", 5)
                        .style("fill", "black")
                        .style("opacity", 0);

                    circles.on("mouseover", function(event, d) {
                        d3.select(this)
                            .style("opacity", 1);
                        lChartArea.append("text")
                            .attr("id", "tooltip")
                            .attr("x", 100)
                            .attr("y", 20)
                            .attr("text-anchor", "middle")
                            .text(`${d.date.toDateString()}, Births: ${d.births}`);
                    });

                    circles.on("mouseout", function(event, d) {
                        d3.select(this).style("opacity", 0);
                        d3.select("#tooltip").remove();
                    });


                };

                drawLineChart(2001);

            }

            requestData();




        </script>
    </body>
</html>
