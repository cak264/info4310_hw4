<html>
    <head>
        <h1>US Births and Birth Superstitions</h1>
        <h3>Cameron Kull, cak264 & Marie Williams, mcw242</h3>
        <script src="https://d3js.org/d3.v7.min.js"></script>

        <style>
            #all {
                margin: 0;
                padding: 0;
                display: flex;
                flex-direction:column;
                justify-content: center;
                align-items: center;
            }

            h1, h3{
                text-align: center;
                position: relative;
                top: 50px;
            }

            #day_of_week_container, #linechart{
                position: relative;
                display: flex;
                top: 70px;
                align-items: center;
            }

            .gridlines line {
              stroke: #bbb;
            }

            .gridlines .domain {
              stroke: none;
            }

            #countsButton {
                position: absolute;
                top: -70px;
                left: 180px;
            }

            #propButton {
                position: absolute;
                top: -70px;
                left: 50px;
            }

            input {
                position: absolute;
                top: -30px;
                left: 200px;
            }

            #select-a-date {
                position: absolute;
                top: -30px;
                left: 50px;
            }

            #submit {
                position: absolute;
                top: -30px;
                left: 275px;
            }

            p {
                padding: 10px;
                margin: 5px;
            }

        </style>
    </head>
    <body>
        <br>
        <br>
        <div id="all">
            <div id="day_of_week_container">
                <button id="countsButton">Counts View</button>
                <button id="propButton">Proportions View</button>
                <svg id="day_of_week_svg2" height="600" width="600"></svg>
                <svg id="day_of_week_svg" height="600" width="600"></svg>
                <text id="select-a-date">Enter a Date (1 - 31)</text>
                <input type="text" id="date-input" minlength="1" maxlength="2" size="4"></input>
                <button id="submit">Update</button>
            </div>

            <svg id="linechart" height="600" width="800"></svg>
        </div>

        <script>

            // Day of week counts histogram
            const histogram = d3.select("#day_of_week_svg");
            const width=histogram.attr("width");
            const height=histogram.attr("height");
            const margins={top: 10, right: 10, bottom: 50, left: 50};
            const chartWidth = width - margins.left - margins.right;
            const chartHeight = height - margins.top - margins.bottom;

            histogram.attr("transform", `translate(${-600})`);

            // Day of week proportion histogram
            const propHistogram = d3.select("#day_of_week_svg2");

            // Line chart
            const linechart = d3.select("#linechart");
            const svg_width = linechart.attr("width");
            const svg_height= linechart.attr("height");
            const lc_margins={top: 10, right: 10, bottom: 50, left: 50};
            const lchartWidth = svg_width - lc_margins.left - lc_margins.right;
            const lchartHeight = svg_height - lc_margins.top - lc_margins.bottom;

            // Data
            let requestData = async function(){
                let births = await d3.csv("US_births_1994-2014.csv", d3.autoType);
                console.log(births);

                let histArea=histogram.append("g")
                                .attr("class", "histArea")
                                .attr('transform', `translate(${margins.left},${margins.top})`);

                let propHistArea=propHistogram.append("g")
                                .attr("class", "propHistArea")
                                .attr('transform', `translate(${margins.left},${margins.top})`);

                // selecting just the 13ths
                let thirteenths = births.filter(b=> b.date_of_month==13);
                console.log(thirteenths);
                let nonThirteenths = births.filter(b=> b.date_of_month!=13);
                console.log(nonThirteenths);

                // dictionary of avgs per day of week
                let bin = d3.bin().value(d=> d.day_of_week)
                                  .thresholds([1,2,3,4,5,6,7]);
                //let dowBins = bin(thirteenths);
                //console.log(dowBins);
                let dowConverter = d3.scaleOrdinal().domain([1,2,3,4,5,6,7]).range(["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]);

                function dowDict(data){
                    // break the data down into bins, separating day of week
                    let dowBins = bin(data);
                    // create a dictionary holding the average births for each day of the week
                    let dowDict = {};
                    let sum = 0;
                    dowBins.forEach(bin =>{

                        bin.forEach(value =>{
                            sum+=value.births;
                        })
                        dowDict[dowConverter(bin.x0)]=Math.floor(sum/bin.length);
                        sum=0;
                    })
                    return dowDict;
                };

                let thirteenthsDict = dowDict(thirteenths);
                console.log(thirteenthsDict);
                let nonThirteenthsDict = dowDict(nonThirteenths);
                console.log(nonThirteenthsDict);

                let propDict = {};
                for (let key in thirteenthsDict){
                    propDict[key] = thirteenthsDict[key]/nonThirteenthsDict[key];
                }
                console.log(propDict);

                let histXScale = d3.scaleBand().domain(Object.keys(thirteenthsDict)).range([0,chartWidth]);
                let histYScale = d3.scaleLinear().domain([Math.min(...Object.values(thirteenthsDict))-1000, Math.max(...Object.values(thirteenthsDict))+1000]).range([chartHeight, 0]);
                let propHistYScale = d3.scaleLinear().domain([0.92, 1.045]).range([chartHeight, 0]);

                function createAxes(yScale, graph, title){
                    let leftAxis = d3.axisLeft(yScale)
                                     .ticks(7);
                    graph.append('g')
                        .attr('transform',`translate(${margins.left-10},${margins.top})`)
                        .call(leftAxis);

                    let leftGridlines = d3.axisLeft(yScale)
                                        .tickSize(-chartWidth-10)
                                        .ticks(7)
                                        .tickFormat('');
                    graph.append('g')
                        .attr('class', 'gridlines')
                        .attr('transform',`translate(${margins.left-10},${margins.top})`)
                        .call(leftGridlines);

                    let bottomAxis = d3.axisBottom(histXScale);
                    graph.append('g')
                        .attr('transform',`translate(${margins.left},${chartHeight+margins.top+10})`)
                        .call(bottomAxis);

                    // axis labels and titles
                    // graph.append('text')
                    //     .text(title)
                    //     .attr("class", "title")
                    //     .attr('x', 320)
                    //     .attr('y', 10)
                    //     .style('font-size', 20)
                    //     .style('font-weight', 'bold')
                    //     .style("text-anchor", "middle")
                    //     .style("alignment-baseline", "central");
                };

                createAxes(histYScale, histogram, "Average Birth Counts on the 13th, 1994-2014");
                createAxes(propHistYScale, propHistogram, "Ratio of Births on the 13th to Births on All Other Dates");

                // add bars

                histArea.selectAll("rect.selectedDate").data(Object.entries(thirteenthsDict))
                        .join("rect")
                        .attr("class", 'selectedDate')
                        .attr("x", d=> histXScale(d[0]))
                        .attr("y", d=> histYScale(d[1]))
                        .attr("width", histXScale.bandwidth())
                        .attr("height", d=> chartHeight - histYScale(d[1]))
                        .attr("fill", "#4a4444");

                histArea.raise();

                propHistArea.selectAll("rect.proportion").data(Object.entries(propDict))
                        .join("rect")
                        .attr("class", 'proportion')
                        .attr("x", d=> histXScale(d[0]))
                        .attr("y", d=> propHistYScale(d[1]))
                        .attr("width", histXScale.bandwidth())
                        .attr("height", d=> chartHeight - propHistYScale(d[1]))
                        .attr("fill", function(d){
                            if (d[0] == "Friday"){return "#d62f2f"}
                            else{return "#4a4444"}
                        });

                propHistArea.raise();
                histogram.attr("visibility", "hidden");

                // add bar interaction

                histArea.selectAll("rect.selectedDate").on("mouseover", function(event, d){
                    d3.select(this)
                      .attr("stroke", "#c4c2c2")
                      .attr("stroke-width", 3);
                    countPanel.append("text")
                        .attr("x", 10)
                        .attr("y", 400)
                        .text(d[1].toString()+" Births")
                        .style("font-size", 17)
                        .style("font-weight", "bold")
                        .attr("class", "count-label");
                })

                histArea.selectAll("rect.selectedDate").on("mouseout", function(event, d){
                    d3.select(this)
                      .attr("stroke", "none");
                    countPanel.selectAll("text.count-label")
                            .text("");
                    
                })

                propHistArea.selectAll("rect.proportion").on("mouseover", function(event, d){
                    d3.select(this)
                      .attr("stroke", "#c4c2c2")
                      .attr("stroke-width", 3);
                    propPanel.append("text")
                        .attr("x", 0)
                        .attr("y", 0)
                        .text(thirteenthsDict[d[0]].toString()+" Births : "+nonThirteenthsDict[d[0]].toString()+" Births")
                        .style("font-size", 16)
                        .style("font-weight", "bold")
                        .attr("class", "prop-label");
                })

                propHistArea.selectAll("rect.proportion").on("mouseout", function(event, d){
                    d3.select(this)
                      .attr("stroke", "none");
                    propPanel.selectAll("text.prop-label")
                            .text("");
                    
                })

                // panel


                let countPanel = d3.select("#day_of_week_container").append("g");
                console.log(countPanel);
                countPanel.style("border", "1px solid black")
                          .attr("class", "count-panel")
                          .style("position", "absolute")
                          .style("bottom", "65px")
                          .style("left", "650px")
                          .style("width", "400px")
                          .style("height", "500px")
                          .style("visibility", "hidden");

                countPanel.append("text")
                          .attr("id", "count-title")
                          .attr("x", 20)
                          .attr("y", 80)
                          .text("Births by Count on the 13th of each month")
                          .style("font-size", 25)
                          .style("font-weight", "bold");
                countPanel.append("p")
                          .text("When comparing the average count of births on the 13th of any month of the span of 1994 - 2014, we can see that there are not the fewest number of births on Friday the 13th. In fact, this histogram appears to unveil a pattern of greater numbers of births on weekdays versus weekends. For almost every date, Tuesdays appear to be the most popular day to give birth, and Sundays are the least popular. ");


                let propPanel = d3.select("#day_of_week_container").append("g");
                propPanel.style("border", "1px solid black")
                          .attr("class", "count-panel")
                          .style("position", "absolute")
                          .style("bottom", "65px")
                          .style("left", "650px")
                          .style("width", "400px")
                          .style("height", "500px")
                          .style("visibility", "visible");

                propPanel.append("text")
                          .attr("id", "prop-title")
                          .attr("x", 20)
                          .attr("y", 80)
                          .text("Ratio of Average Births on the 13th to Births on All Other Dates")
                          .style("font-size", 25)
                          .style("font-weight", "bold");

                propPanel.append("p")
                          .text("This graphs compares the average number of births on the any given date of each month to the average number of births on all other dates for each month over the span of 1994 - 2014. When looking at the 13th, we can see the ratio of births on the 13th to births not on the 13th for Friday is much lower than the other days of the week. This unveils that if a baby is born on a Friday, the parents prefer the date of that Friday to not be the 13th, showing that people are supersticious about Friday the 13th. Other dates that seem to potentially be supersticiously impacted are FILL THE REST IN... ")


                d3.select("#countsButton").on("click", function(){
                    histogram.attr("visibility", "visible");
                    propHistogram.attr("visibility", "hidden");
                    countPanel.style("visibility", "visible");
                    propPanel.style("visibility", "hidden");

                });

                d3.select("#propButton").on("click", function(){
                    histogram.attr("visibility", "hidden");
                    propHistogram.attr("visibility", "visible");
                    countPanel.style("visibility", "hidden");
                    propPanel.style("visibility", "visible");
                    
                });

                // date input

                let submit = d3.select("#submit");
                
                submit.on("click", function(){
                    let date = parseInt(document.getElementById("date-input").value);
                    if (date>0 & date<32){
                        updateDate(date);
                    }
                        
                })

                function updateDate(date){

                    let includingDate = births.filter(b=> b.date_of_month == date);
                    let notIncludingDate = births.filter(b=> b.date_of_month != date);

                    let dateDict = dowDict(includingDate);
                    let nonDateDict = dowDict(notIncludingDate);

                    let propDict = {};
                    for (let key in dateDict){
                        propDict[key] = dateDict[key]/nonDateDict[key];
                    }

                    histArea.selectAll("rect.selectedDate").data(Object.entries(dateDict))
                        .join("rect")
                        .attr("class", "selectedDate")
                        .transition().duration(200)
                        .attr("x", d=> histXScale(d[0]))
                        .attr("y", d=> histYScale(d[1]))
                        .attr("width", histXScale.bandwidth())
                        .attr("height", d=> chartHeight - histYScale(d[1]))
                        .attr("fill", "#4a4444");

                    propHistArea.selectAll("rect.proportion").data(Object.entries(propDict))
                        .join("rect")
                        .attr("class", 'proportion')
                        .transition().duration(200)
                        .attr("x", d=> histXScale(d[0]))
                        .attr("y", d=> propHistYScale(d[1]))
                        .attr("width", histXScale.bandwidth())
                        .attr("height", d=> chartHeight - propHistYScale(d[1]))
                        .attr("fill", function(d){
                            if (d[1] == Math.min(...Object.values(propDict))){return "#d62f2f"}
                            else{return "#4a4444"}
                        });
                    
                    if ([1, 21, 31].includes(date)){
                        d3.select("#count-title").text("Births by Count on the "+date.toString()+"st of each month")
                        d3.select("#prop-title").text("Ratio of Average Births on the "+date.toString()+"st to Births on All Other Dates")
                    }
                    else if ([2, 22].includes(date)){
                        d3.select("#count-title").text("Births by Count on the "+date.toString()+"nd of each month")
                        d3.select("#prop-title").text("Ratio of Average Births on the "+date.toString()+"nd to Births on All Other Dates")
                    }
                    else if ([3, 23].includes(date)){
                        d3.select("#count-title").text("Births by Count on the "+date.toString()+"rd of each month")
                        d3.select("#prop-title").text("Ratio of Average Births on the "+date.toString()+"rd to Births on All Other Dates")
                    }
                    else {
                        d3.select("#count-title").text("Births by Count on the "+date.toString()+"th of each month")
                        d3.select("#prop-title").text("Ratio of Average Births on the "+date.toString()+"th to Births on All Other Dates")
                    }
                    
                    
                }


                // line chart
                let lChartArea = linechart.append("g")
                                // .attr("class", "linecArea")
                                .attr('transform', `translate(${lc_margins.left},${lc_margins.top})`);

                function drawLineChart(year){
                    const dataYear = births.filter(d => d.year === year);

                    dataYear.forEach(d => {
                        d.date = new Date(d.year, d.month-1, d.date_of_month);
                    });

                    const averageBirths = d3.mean(dataYear, d => d.births);

                    const lcxScale = d3.scaleTime().domain(d3.extent(dataYear, d => d.date)).range([0, lchartWidth]);
                    const lcyScale = d3.scaleLinear().domain([d3.min(dataYear, d => d.births) - averageBirths, d3.max(dataYear, d => d.births) - averageBirths]).range([lchartHeight, 0]);


                    const line = d3.line()
                        .x(d => lcxScale(d.date))
                        .y(d => lcyScale(d.births - averageBirths));

                    const lcxAxis = d3.axisBottom(lcxScale)
                        .tickFormat(d3.timeFormat("%b"));
                    linechart.append('g')
                        .attr('transform', `translate(${lc_margins.left},${lchartHeight + lc_margins.top+20})`)
                        .call(lcxAxis);

                    const lcyAxis = d3.axisLeft(lcyScale)
                        .tickFormat(function(d) {
                            if (d === 0) {
                                return 'Avg';
                            } else if (d>0) {
                                return '+' + d;
                            } else {
                                return d;
                            }
                        });
                    linechart.append('g')
                        .attr('transform', `translate(${lc_margins.left-10},${lc_margins.top})`)
                        .call(lcyAxis);

                    let lcleftGridlines = d3.axisLeft(lcyScale)
                                        .tickSize(-lchartWidth-10)
                                        .tickFormat('');
                    lChartArea.append('g')
                        .attr('class', 'gridlines')
                        .attr('transform',`translate(${lc_margins.left-60}, 0)`)
                        .call(lcleftGridlines);

                    lChartArea.append("line")
                        .attr("class", "average-line")
                        .attr("x1", lc_margins.left-60) //-60
                        .attr("y1", lcyScale(0) + lc_margins.top-10)
                        .attr("x2", lc_margins.left + lchartWidth)
                        .attr("y2", lcyScale(0) + lc_margins.top-10)
                        .style("stroke", "#d62f2f")
                        .style("stroke-width", 2);


                    lChartArea.append("path")
                        .datum(dataYear)
                        .attr("class", "line-chart")
                        .attr("fill", "none")
                        .attr("stroke", "#4a4444")
                        .attr("stroke-width", 1.5)
                        .attr("d", line);

                    // hovering
                    let circles = lChartArea.selectAll("circle").data(dataYear)
                        .join("circle")
                        .attr("class", "point")
                        .attr("cx", d => lcxScale(d.date))
                        .attr("cy", d => lcyScale(d.births)+800)
                        .attr("r", 5)
                        .style("fill", "black")
                        .style("opacity", 0);

                    circles.on("mouseover", function(event, d) {
                        d3.select(this)
                            .style("opacity", 1);
                        lChartArea.append("text")
                            .attr("id", "tooltip")
                            .attr("x", 100)
                            .attr("y", 20)
                            .attr("text-anchor", "middle")
                            .text(`${d.date.toDateString()}, Births: ${d.births}`);
                    });

                    circles.on("mouseout", function(event, d) {
                        d3.select(this).style("opacity", 0);
                        d3.select("#tooltip").remove();
                    });


                };

                drawLineChart(2001);

            }

            requestData();




        </script>
    </body>
</html>
