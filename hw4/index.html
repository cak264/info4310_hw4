<html>
    <head>
        <h1>US Births and Birth Superstitions</h1>
        <h3 id="head_h3">Cameron Kull, cak264 & Marie Williams, mcw242</h3>
        <script src="https://d3js.org/d3.v7.min.js"></script>

        <style>
            #all {
                margin: 0;
                padding: 0;
                display: flex;
                flex-direction:column;
                justify-content: center;
                align-items: center;
            }

            h1, #head_h3{
                text-align: center;
                position: relative;
                top: 50px;
            }

            #day_of_week_container, #linechart, #avgChart{
                position: relative;
                display: flex;
                top: 70px;
                align-items: center;
            }

            .gridlines line {
              stroke: #bbb;
            }

            .gridlines .domain {
              stroke: none;
            }

            #countsButton {
                position: absolute;
                top: -70px;
                left: 180px;
            }

            #propButton {
                position: absolute;
                left: 50px;
            }

            #countsButton, #propButton {
                top: -80px;
                height: 35px;
                width: 120px;
            }

            #date-input {
                position: absolute;
                top: -32px;
                left: 190px;
                height: 34px;
            }

            #select-a-date {
                position: absolute;
                top: -27px;
                left: 50px;
            }

            #submit {
                position: absolute;
                top: -33px;
                left: 250px;
                height: 35px;
            }

            #animate {
                position: absolute;
                top: -33px;
                left: 410px;
                height: 35px;
            }

            .animationDate {
                position: absolute;
                top: 30px;
                left: 525px;
            }

            p {
                padding-left: 10px;
                margin: 5px;
                margin-right: 10px;
            }

            #lc_div, #year-filter, .day-filter, #avg_div {
                /* padding-bottom: 50px; */
                display: flex;
                flex-direction: row;
                justify-content: flex-start;
                align-items: flex-start;
            }


            #linechart {
                width: 70%;
                height: 500px;
            }

            #filters, #avg_filters {
                margin-top: 75px;
                height: 400px;
                width: 400px;
                border: 1px solid black;
            }

            h2, #prop-subtitle {
                margin-top: 10px;
                margin-left: 15px;
            }


            #yearInput, #lc_update, #date_update {
                margin-top: 3px;
                margin-right: 8px;
            }

            #date_update, #avg_date_update {
                margin-left: 8px;
                margin-top: 0px;

            }

            #lc_h1 {
                margin-top: 80px;
            }

            button {
                /* border-radius: 5px; */
                font-family: "Times New Roman", Times, serif;
                padding: 5px;
                /* border: 1px solid black; */
                border: none;
                height: 25px;
                transition-duration: 0.4s;
            }

            button:hover{
                background-color: #4a4444;
                color: white;
            }

            input {
                width: 50px;
                height: 25px;
                border-radius: 0px;
                border: 1px solid black;
            }

            .box_h3 {
                margin-left: 15px;
                margin-top: 8px;
                margin-bottom: 8px;
            }

            #avgChart {
                width: 70%;
                height: 550px;

            }

            #holidayCheck{
                height: auto;
                width: auto;
                margin-left: 15px;
            }

            #holidayCheck text {
                margin-left: 5px;
            }

            #disclaimer {
                position: absolute;
                left: 50px;
                top: 10px;
                background-color: white;
            }

        </style>
    </head>
    <body>
        <br>
        <br>
        <div id="all">
            <div id="day_of_week_container">
                <!-- <p>Select Your View: </p> -->
                <button id="countsButton">View Counts</button>
                <button id="propButton">View Proportions</button>
                <svg id="day_of_week_svg2" height="600" width="600"></svg>
                <svg id="day_of_week_svg" height="600" width="600"></svg>
                <text id="select-a-date">Enter a Date (1 - 31): </text>
                <input type="text" id="date-input" minlength="1" maxlength="2" size="4"></input>
                <button id="submit">Update</button>
                <button id="animate">View Change Across the Month</button>
                <text id="disclaimer">*Excluding Major Holidays</text>
            </div>

            <h1 id="lc_h1">Birth Trends Over A Year</h1>
            <div id="lc_div">
                <svg id="linechart" height="420" width="1000"></svg>
                <div id="filters">
                    <h2>Tailor Your Exploration</h2>
                    <p id="yearMessage"></p>
                    <h3 class="box_h3">Year Selection</h3>
                    <p>Curious about a specific year? Enter a year of your choosing, between 1994 and 2014, to see the birth trends for that year!</p>
                    <div id="year-filter">
                        <p>Enter Year (1994-2014):</p>
                        <input type="number" id="yearInput" min="1994" max="2014">
                        <button id="lc_update">Update</button>
                    </div>
                    <h3 class="box_h3">Day Selection</h3>
                    <p>Hover over any point to see the number of births recorded for that day, or enter a date below to learn more about it!</p>
                    <div class="day-filter">
                        <p>Enter Month (1-12):</p>
                        <input type="number" id="monthInput" min="1" max="12">
                    </div>
                    <div class="day-filter">
                        <p>Enter Day of the Month (1-31):</p>
                        <input type="number" id="dayInput" min="1" max="31">
                        <button id="date_update">Update</button>
                    </div>
                    <p id="dayMessage"></p>
                </div>
            </div>

            <h1>Average Birth Trends Over A Year (1994-2014)</h1>
            <div id="avg_div">
                <svg id="avgChart" height="420" width="1000"></svg>
                <div id="avg_filters">
                    <h2>Tailor Your Exploration</h2>
                    <p>This line chart shows the average number of recorded births associated with every day of the year, based on birth data between 1994 and 2014. The red average line represents the average number of births recorded per day between 1994-2014, at <b>11174 births</b>.</p>
                    <h3 class="box_h3">Holidays and Special Dates</h3>
                    <input type="checkbox" id="holidayCheck">Highlight Holidays & Other Dates of Note</input>
                    <h3 class="box_h3">Day Selection</h3>
                    <p>Hover over any point to see the number of births recorded for that day, or enter a date below to learn more about it! You can also just enter a day of a month to see patterns over a year. Hint: Try 13!</p>
                    <div class="day-filter">
                        <p>Enter Month (1-12):</p>
                        <input type="number" id="avgmonthInput" min="1" max="12">
                    </div>
                    <div class="day-filter">
                        <p>Enter Day of the Month (1-31):</p>
                        <input type="number" id="avgdayInput" min="1" max="31">
                        <button id="avg_date_update">Update</button>
                    </div>
                    <p id="avg_message"></p>
                </div>
            </div>

        </div>

        <script>

            // Day of week counts histogram
            const histogram = d3.select("#day_of_week_svg");
            const width=histogram.attr("width");
            const height=histogram.attr("height");
            const margins={top: 10, right: 10, bottom: 50, left: 50};
            const chartWidth = width - margins.left - margins.right;
            const chartHeight = height - margins.top - margins.bottom;

            histogram.attr("transform", `translate(${-600})`);

            // Day of week proportion histogram
            const propHistogram = d3.select("#day_of_week_svg2");

            // Line chart
            const linechart = d3.select("#linechart");
            const svg_width = linechart.attr("width");
            const svg_height= linechart.attr("height");
            const lc_margins={top: 10, right: 10, bottom: 50, left: 50};
            const lchartWidth = svg_width - lc_margins.left - lc_margins.right;
            const lchartHeight = svg_height - lc_margins.top - lc_margins.bottom;

            const avgchart = d3.select("#avgChart");
            const avg_width = avgchart.attr("width");
            const avg_height= avgchart.attr("height");
            const avg_margins={top: 10, right: 10, bottom: 50, left: 50};
            const avgChartWidth = avg_width - avg_margins.left - avg_margins.right;
            const avgChartHeight = avg_height - avg_margins.top - avg_margins.bottom;

            // Data
            let requestData = async function(){
                let births = await d3.csv("US_births_1994-2014.csv", d3.autoType);
                console.log(births);
                let holidays = [[1,1], [7,4], [12, 25], [2,14], [3,17], [5,5], [10,31], [12,31], [2, 29], [9,11]];
                let birthsNoHolidays = births;

                holidays.forEach(holiday => {
                    birthsNoHolidays = birthsNoHolidays.filter(b=> {
                        return b.month !== holiday[0] || b.date_of_month !== holiday[1];
                    })
                })

                //console.log(birthsNoHolidays);

                let histArea=histogram.append("g")
                                .attr("class", "histArea")
                                .attr('transform', `translate(${margins.left},${margins.top})`);

                let propHistArea=propHistogram.append("g")
                                .attr("class", "propHistArea")
                                .attr('transform', `translate(${margins.left},${margins.top})`);

                // selecting just the 13ths
                let thirteenths = birthsNoHolidays.filter(b=> b.date_of_month==13);
                let nonThirteenths = birthsNoHolidays.filter(b=> b.date_of_month!=13);

                // dictionary of avgs per day of week
                let bin = d3.bin().value(d=> d.day_of_week)
                                  .thresholds([1,2,3,4,5,6,7]);
                let dowConverter = d3.scaleOrdinal().domain([1,2,3,4,5,6,7]).range(["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]);

                function dowDict(data){
                    // break the data down into bins, separating day of week
                    let dowBins = bin(data);
                    // create a dictionary holding the average births for each day of the week
                    let dowDict = {};
                    let sum = 0;
                    dowBins.forEach(bin =>{

                        bin.forEach(value =>{
                            sum+=value.births;
                        })
                        dowDict[dowConverter(bin.x0)]=Math.floor(sum/bin.length);
                        sum=0;
                    })
                    return dowDict;
                };

                let thirteenthsDict = dowDict(thirteenths);
                let nonThirteenthsDict = dowDict(nonThirteenths);

                let histXScale = d3.scaleBand().domain(Object.keys(thirteenthsDict)).range([0,chartWidth]);
                let histYScale = d3.scaleLinear().domain([Math.min(...Object.values(thirteenthsDict))-1000, Math.max(...Object.values(thirteenthsDict))+1000]).range([chartHeight, 0]);
                let propHistYScale = d3.scaleLinear().domain([0.92, 1.045]).range([chartHeight, 0]);

                function createAxes(yScale, graph){
                    let leftAxis = d3.axisLeft(yScale)
                                     .ticks(7);
                    graph.append('g')
                        .attr('transform',`translate(${margins.left-10},${margins.top})`)
                        .call(leftAxis);

                    let leftGridlines = d3.axisLeft(yScale)
                                        .tickSize(-chartWidth-10)
                                        .ticks(7)
                                        .tickFormat('');
                    graph.append('g')
                        .attr('class', 'gridlines')
                        .attr('transform',`translate(${margins.left-10},${margins.top})`)
                        .call(leftGridlines);

                    let bottomAxis = d3.axisBottom(histXScale);
                    graph.append('g')
                        .attr('transform',`translate(${margins.left},${chartHeight+margins.top+10})`)
                        .call(bottomAxis);
                };

                createAxes(histYScale, histogram);
                createAxes(propHistYScale, propHistogram);

                updateDate(13);
                histArea.raise();
                propHistArea.raise();
                histogram.attr("visibility", "hidden");

                // panel

                let countPanel = d3.select("#day_of_week_container").append("g");
                countPanel.style("border", "1px solid black")
                          .attr("class", "count-panel")
                          .style("position", "absolute")
                          .style("bottom", "65px")
                          .style("left", "650px")
                          .style("width", "400px")
                          .style("height", "520px")
                          .style("visibility", "hidden");

                countPanel.append("h2")
                          .attr("id", "count-title")
                          .attr("x", 20)
                          .attr("y", 80)
                          .text("Births by Count on the 13th of each month")
                          .style("font-size", 25)
                          .style("font-weight", "bold");
                countPanel.append("p")
                          .html("When comparing the average count of births on the 13th of any month of the span of 1994 - 2014, we can see that <strong>there are not the fewest number of births on Friday the 13th</strong>. In fact, this histogram appears to unveil a pattern of greater numbers of births on weekdays versus weekends. As the graph animates from the 1st to the 31st, one can notice that births appear to <strong>peak on Tuesdays and Wednesdays, and dip to their lowest values on Saturdays and Sundays</strong>. ");

                let propPanel = d3.select("#day_of_week_container").append("g");
                propPanel.style("border", "1px solid black")
                          .attr("class", "count-panel")
                          .style("position", "absolute")
                          .style("bottom", "65px")
                          .style("left", "650px")
                          .style("width", "600px")
                          .style("height", "520px")
                          .style("visibility", "visible");

                propPanel.append("h2")
                          .attr("id", "prop-title")
                          .attr("x", 20)
                          .attr("y", 80)
                          .text("Ratio of Average Births on the 13th to Births on All Other Dates")
                          .style("font-size", 25)
                          .style("font-weight", "bold");

                propPanel.append("p")
                          .html("This graphs compares the average number of births on any given day of each month to the average number of births on all other dates for each month over the span of 1994 - 2014.  <strong>The ratio metric along the y axis represents the comparison of average births on the specified date, to average births on any other date</strong>. Given this, a ratio of 1.0 occurs when these average births counts are equal to each other, and a <strong>ratio less than 1.0 occurs when the average birth counts on the selected date are less than the average birth counts regardless of date </strong>for the given weekday.");
                propPanel.append("h3")
                         .text("Dates of Note")
                         .attr("id", "prop-subtitle");
                propPanel.append("p")
                         .html("Some dates that appear to have a more extreme deviation on a certain weekday from the average of the rest of the dates of the month are the Friday the 13th, Monday the 1st, Monday the 5th, Thursday the 22nd, and Monday the 31st. When looking at the 13th, we can see <strong>the ratio of births on the 13th to births not on the 13th is below 1.0 for every day of the week, and the Friday ratio is even lower than the other days of the week</strong>. This unveils that people are supersticious about having their child born on the 13th, even more so if it is Friday the 13th. We can see similar effects with those other dates of note, like Monday the 1st and 31st having a ratio of about 0.97 and 0.93 respectively when the rest of the days of the week have a ratio around of above 1.0. This shows that parents are averse to having their child on a Monday when it is the first or the last day of the month.");


                d3.select("#countsButton").on("click", function(){
                    histogram.attr("visibility", "visible");
                    propHistogram.attr("visibility", "hidden");
                    countPanel.style("visibility", "visible");
                    propPanel.style("visibility", "hidden");

                });

                d3.select("#propButton").on("click", function(){
                    histogram.attr("visibility", "hidden");
                    propHistogram.attr("visibility", "visible");
                    countPanel.style("visibility", "hidden");
                    propPanel.style("visibility", "visible");

                });

                // date input

                let submit = d3.select("#submit");

                submit.on("click", function(){
                    let date = parseInt(document.getElementById("date-input").value);
                    if (date>0 & date<32){
                        updateDate(date);
                    }

                })


                function updateDate(date){

                    let includingDate = birthsNoHolidays.filter(b=> b.date_of_month == date);
                    let notIncludingDate = birthsNoHolidays.filter(b=> b.date_of_month != date);

                    let dateDict = dowDict(includingDate);
                    let nonDateDict = dowDict(notIncludingDate);

                    let propDict = {};
                    for (let key in dateDict){
                        propDict[key] = dateDict[key]/nonDateDict[key];
                    }


                    histArea.selectAll("rect.selectedDate").data(Object.entries(dateDict))
                        .join("rect")
                        .attr("class", "selectedDate")
                        .transition().duration(200)
                        .attr("x", d=> histXScale(d[0]))
                        .attr("y", d=> histYScale(d[1]))
                        .attr("width", histXScale.bandwidth()-5)
                        .attr("height", d=> chartHeight - histYScale(d[1]))
                        .attr("fill", "#bf0404");

                    propHistArea.selectAll("rect.proportion").data(Object.entries(propDict))
                        .join("rect")
                        .attr("class", 'proportion')
                        .transition().duration(200)
                        .attr("x", d=> histXScale(d[0]))
                        .attr("y", d=> propHistYScale(d[1]))
                        .attr("width", histXScale.bandwidth()-5)
                        .attr("height", d=> chartHeight - propHistYScale(d[1]))
                        .attr("fill", function(d){
                            if (d[1] == Math.min(...Object.values(propDict))){return "#f54242"}
                            else{return "#4a4444"}
                        });

                    if ([1, 21, 31].includes(date)){
                        d3.select("#count-title").text("Births by Count on the "+date.toString()+"st of each month")
                        d3.select("#prop-title").text("Ratio of Average Births on the "+date.toString()+"st to Births on All Other Dates")
                    }
                    else if ([2, 22].includes(date)){
                        d3.select("#count-title").text("Births by Count on the "+date.toString()+"nd of each month")
                        d3.select("#prop-title").text("Ratio of Average Births on the "+date.toString()+"nd to Births on All Other Dates")
                    }
                    else if ([3, 23].includes(date)){
                        d3.select("#count-title").text("Births by Count on the "+date.toString()+"rd of each month")
                        d3.select("#prop-title").text("Ratio of Average Births on the "+date.toString()+"rd to Births on All Other Dates")
                    }
                    else {
                        d3.select("#count-title").text("Births by Count on the "+date.toString()+"th of each month")
                        d3.select("#prop-title").text("Ratio of Average Births on the "+date.toString()+"th to Births on All Other Dates")
                    }

                    // add bar interaction

                    histArea.selectAll("rect.selectedDate").on("mouseover", function(event, d){
                        d3.select(this)
                        .attr("stroke", "black")
                        .attr("stroke-width", 4);
                        countPanel.append("p")
                            .attr("x", 10)
                            .attr("y", 400)
                            .text(d[1].toString()+" Births")
                            .style("font-size", 17)
                            .style("font-weight", "bold")
                            .attr("class", "count-label");
                    })

                    histArea.selectAll("rect.selectedDate").on("mouseout", function(event, d){
                        d3.select(this)
                        .attr("stroke", "none");
                        countPanel.selectAll("p.count-label")
                                .text("");

                    })

                    propHistArea.selectAll("rect.proportion").on("mouseover", function(event, d){
                        d3.select(this)
                        .attr("stroke", "black")
                        .attr("stroke-width", 4);
                        propPanel.append("p")
                            .attr("x", 0)
                            .attr("y", 0)
                            .text("Birth Ratio: "+ dateDict[d[0]].toString()+" to "+nonDateDict[d[0]].toString()+" Births")
                            .style("font-size", 16)
                            .style("font-weight", "bold")
                            .attr("class", "prop-label");
                    })

                    propHistArea.selectAll("rect.proportion").on("mouseout", function(event, d){
                        d3.select(this)
                        .attr("stroke", "none");
                        propPanel.selectAll("p.prop-label")
                                .text("");

                    })

                }

                // animate

                d3.select("#animate").on("click", animate);

                let animationDateLabel = d3.select("#day_of_week_container").append("text")
                                            .attr("x", 0)
                                            .attr("y", 0)
                                            .text("1st")
                                            .style("font-size", 40)
                                            .style("font-weight", "bold")
                                            .attr("class", "animationDate")
                                            .style("visibility", "hidden");

                function animate() {
                    // Start date: 1st of the month
                    let currentDate = 1;
                    let endDate = 31

                    const interval = 500;

                    // Interval function
                    const animationInterval = setInterval(() => {
                        // Call updateDate() with the current date
                        updateDate(currentDate);

                        // set the label appropriately
                        animationDateLabel.style("visibility", "visible");
                        if ([1, 21, 31].includes(currentDate)){
                            animationDateLabel.text(currentDate.toString()+"st")
                        }
                        else if ([2, 22].includes(currentDate)){
                            animationDateLabel.text(currentDate.toString()+"nd")
                        }
                        else if ([3, 23].includes(currentDate)){
                            animationDateLabel.text(currentDate.toString()+"rd")
                        }
                        else {
                            animationDateLabel.text(currentDate.toString()+"th")
                        }

                        // Increment date by one day
                        currentDate+=1;

                        // Check if we've reached the end date
                        if (currentDate > endDate) {
                            clearInterval(animationInterval);
                            animationDateLabel.style("visibility", "hidden");
                        }
                    }, interval);
                }


                // line chart
                let lChartArea = linechart.append("g")
                                // .attr("class", "linecArea")
                                .attr('transform', `translate(${lc_margins.left},${lc_margins.top})`);

                function drawLineChart(year, highlightDate = null){

                    const dataYear = births.filter(d => d.year === year);

                    dataYear.forEach(d => {
                        d.date = new Date(d.year, d.month-1, d.date_of_month);
                    });
                    console.log(dataYear);

                    const averageBirths = d3.mean(dataYear, d => d.births);
                    console.log(averageBirths);

                    const lcxScale = d3.scaleTime().domain(d3.extent(dataYear, d => d.date)).range([0, lchartWidth]);
                    const lcyScale = d3.scaleLinear().domain([d3.min(dataYear, d => d.births) - averageBirths, d3.max(dataYear, d => d.births) - averageBirths]).range([lchartHeight, 0]);


                    const line = d3.line()
                        .x(d => lcxScale(d.date))
                        .y(d => lcyScale(d.births - averageBirths));

                    linechart.selectAll('.x-axis, .y-axis, .gridlines, .average-line, .line-chart, .point').remove();

                    const lcxAxis = d3.axisBottom(lcxScale)
                        .tickFormat(d3.timeFormat("%b"));
                    linechart.append('g')
                        .attr('transform', `translate(${lc_margins.left},${lchartHeight + lc_margins.top+20})`)
                        .attr('class', 'x-axis')
                        .call(lcxAxis);

                    const lcyAxis = d3.axisLeft(lcyScale)
                        .tickFormat(function(d) {
                            if (d === 0) {
                                return 'Avg';
                            } else if (d>0) {
                                return '+' + d;
                            } else {
                                return d;
                            }
                        });
                    linechart.append('g')
                        .attr('transform', `translate(${lc_margins.left-10},${lc_margins.top})`)
                        .attr('class', 'y-axis')
                        .call(lcyAxis);

                    let lcleftGridlines = d3.axisLeft(lcyScale)
                                        .tickSize(-lchartWidth-10)
                                        .tickFormat('');
                    lChartArea.append('g')
                        .attr('class', 'gridlines')
                        .attr('transform',`translate(${lc_margins.left-60}, 0)`)
                        .call(lcleftGridlines);

                    lChartArea.append("line")
                        .attr("class", "average-line")
                        .attr("x1", lc_margins.left-60) //-60
                        .attr("y1", lcyScale(0) + lc_margins.top-10)
                        .attr("x2", lc_margins.left + lchartWidth-40)
                        .attr("y2", lcyScale(0) + lc_margins.top-10)
                        .style("stroke", "#d62f2f")
                        .style("stroke-width", 2);


                    lChartArea.append("path")
                        .datum(dataYear)
                        .attr("class", "line-chart")
                        .attr("fill", "none")
                        .attr("stroke", "#4a4444")
                        .attr("stroke-width", 1.5)
                        .attr("d", line);

                    // hovering
                    let circles = lChartArea.selectAll("circle").data(dataYear)
                        .join("circle")
                        .attr("class", "point")
                        .attr("cx", d => lcxScale(d.date))
                        .attr("cy", d => lcyScale(d.births-averageBirths))
                        .attr("r", 5)
                        .style("fill", "black")
                        .style("opacity", 0);

                    circles.on("mouseover", function(event, d) {
                        d3.select(this)
                            .style("opacity", 1);
                        lChartArea.append("rect")
                            .attr("x", -10)
                            .attr("y", 0)
                            .attr("width", 215)
                            .attr("height", 30)
                            .attr("id","rect")
                            .style("fill","white");
                        lChartArea.append("text")
                            .attr("id", "tooltip")
                            .attr("x", 100)
                            .attr("y", 10)
                            .attr("text-anchor", "middle")
                            .text(`${d.date.toDateString()}, Births: ${d.births}`);
                    });

                    circles.on("mouseout", function(event, d) {
                        d3.select(this).style("opacity", 0);
                        d3.select("#tooltip").remove();
                        d3.select("#rect").remove();
                    });

                    if (highlightDate) {
                        const { year, month, day } = highlightDate;
                        console.log(lcxScale);
                        highlightSelectedDate(year, month, day, lcxScale, lcyScale, dataYear, averageBirths);
                    }

                };

                //updating line chart
                let update = d3.select("#lc_update");
                let yearMessage = d3.select("#yearMessage")
                                    .html("You are currently viewing the distribution of births for <b>1994</b>. The average number of births for this year is <b>10829</b>.");
                let dayMessage = d3.select("#dayMessage");

                update.on("click", function(event, d){
                    const yearInput = parseInt(document.getElementById("yearInput").value);
                    const dataYear = births.filter(d => d.year === yearInput);
                    const averageBirths = Math.round(d3.mean(dataYear, d => d.births));
                    yearMessage.html("You are currently viewing the distribution of births for <b>"+yearInput+"</b>. The average number of births for this year is <b>"+averageBirths+"</b>.");
                    dayMessage.html("");
                    if (yearInput >= 1994 && yearInput <= 2014) {
                        drawLineChart(yearInput);
                    } else {
                        alert("Please enter a year between 1994 and 2014.");
                    }
                })

                function highlightSelectedDate(year, month, day, lcxScale, lcyScale, data, avgbirths) {
                    const selectedDate = new Date(year, month - 1, day);

                    const selectedDataPoint = data.find(d => {
                        return d.date.getFullYear() === year &&
                               d.date.getMonth() === month - 1 &&
                               d.date.getDate() === day;
                    });


                    if (selectedDataPoint) {
                        let highlightedCircle = lChartArea.append("circle")
                            .attr("class", "highlighted-point")
                            .attr("cx", lcxScale(selectedDate))
                            .attr("cy", lcyScale(selectedDataPoint.births - avgbirths))
                            .attr("r", 5)
                            .style("fill", "#d62f2f")
                            .style("stroke", "#d62f2f");

                            highlightedCircle.on("mouseover", function(event, d) {
                                d3.select(this).style("r", 8);
                                lChartArea.append("rect")
                                    .attr("x", -10)
                                    .attr("y", 0)
                                    .attr("width", 215)
                                    .attr("height", 30)
                                    .attr("id","rect")
                                    .style("fill","white");
                                lChartArea.append("text")
                                    .attr("id", "tooltip")
                                    .attr("x", 100)
                                    .attr("y", 10)
                                    .attr("text-anchor", "middle")
                                    .text(`${selectedDataPoint.date.toDateString()}, Births: ${selectedDataPoint.births}`);
                            });

                            highlightedCircle.on("mouseout", function(event, d) {
                                d3.select(this).style("r", 5);
                                d3.select("#tooltip").remove();
                                d3.select("#rect").remove();
                            });

                            dayMessage.html(`<b>Selected Date:</b> ${selectedDataPoint.date.toDateString()} <b>Births:</b> ${selectedDataPoint.births}`);


                    } else {
                        alert("No data available for the entered date.");
                    }
                }

                let date_update = d3.select("#date_update");

                date_update.on("click", function(event, d){
                    const year = parseInt(document.getElementById("yearInput").value)|| 1994;
                    const month = parseInt(document.getElementById("monthInput").value);
                    const day = parseInt(document.getElementById("dayInput").value);

                    if (year >= 1994 && year <= 2014 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                        drawLineChart(year, {year: year, month: month, day: day});
                    } else {
                        alert("Please enter valid values for year (1994-2014), month (1-12), and day (1-31).");
                    }
                })

                drawLineChart(1994);


                //avg chart
                let avgChartArea = avgchart.append("g")
                                .attr('transform', `translate(${avg_margins.left},${avg_margins.top})`);

                //creating dictionary with averages
                const avgBirths = {};
                const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

                for (let month = 1; month <= 12; month++) {
                    const days = daysInMonth[month - 1];

                    for (let day = 1; day <= days; day++) {
                        const date = new Date(1992, month - 1, day);

                        const birthsOnDate = births.filter(d => d.month === month && d.date_of_month === day);
                        const totalBirths = birthsOnDate.reduce((sum, d) => sum + d.births, 0);
                        const averageBirths = birthsOnDate.length > 0 ? totalBirths / birthsOnDate.length : 0;

                        avgBirths[date] = averageBirths;
                    }
                }

                const feb29 = births.filter(d => [1996, 2000, 2004, 2008, 2012].includes(d.year) && d.month === 2 && d.date_of_month === 29);
                const totalBirthsFeb29 = feb29.reduce((sum, d) => sum + d.births, 0);
                const avgBirthsFeb29 = totalBirthsFeb29/feb29.length;

                const feb29_1992 = new Date(1992, 1, 29);
                avgBirths[feb29_1992] = avgBirthsFeb29;
                // console.log(avgBirthsFeb29);
                // console.log(avgBirths[feb29_1992]);

                const dates = Object.keys(avgBirths).map(dateStr => new Date(dateStr));
                const averageBirths = Object.values(avgBirths);
                dates.splice(59, 0, dates.pop());
                averageBirths.splice(59, 0, averageBirths.pop());
                // console.log(dates);
                // console.log(averageBirths);

                const avg_sum = averageBirths.reduce((accumulator, currentValue) => accumulator + currentValue, 0);
                const avg_avg = avg_sum / averageBirths.length;
                console.log(avg_avg);

                const avgxScale = d3.scaleTime().domain(d3.extent(dates)).range([0, avgChartWidth]);
                const avgyScale = d3.scaleLinear().domain([d3.min(averageBirths) - avg_avg, d3.max(averageBirths) - avg_avg]).range([avgChartHeight, 0]);

                const line = d3.line()
                    .x(d => avgxScale(dates[d]))
                    .y(d => avgyScale(averageBirths[d] - avg_avg));

                const avgxAxis = d3.axisBottom(avgxScale)
                    .tickFormat(d3.timeFormat("%b"));
                avgchart.append('g')
                    .attr('transform', `translate(${avg_margins.left},${avgChartHeight + avg_margins.top+10})`)
                    .attr('class', 'x-axis')
                    .call(avgxAxis);

                const avgyAxis = d3.axisLeft(avgyScale)
                    .tickFormat(function(d) {
                        if (d === 0) {
                            return 'Avg';
                        } else if (d>0) {
                            return '+' + d;
                        } else {
                            return d;
                        }
                    });
                avgchart.append('g')
                    .attr('transform', `translate(${avg_margins.left-10},${avg_margins.top})`)
                    .attr('class', 'y-axis')
                    .call(avgyAxis);

                let avgleftGridlines = d3.axisLeft(avgyScale)
                                    .tickSize(-avgChartWidth-10)
                                    .tickFormat('');
                avgChartArea.append('g')
                    .attr('class', 'gridlines')
                    .attr('transform',`translate(${avg_margins.left-60}, 0)`)
                    .call(avgleftGridlines);

                avgChartArea.append("line")
                    .attr("class", "average-line")
                    .attr("x1", avg_margins.left-60)
                    .attr("y1", avgyScale(0) + avg_margins.top-10)
                    .attr("x2", avg_margins.left + avgChartWidth-40)
                    .attr("y2", avgyScale(0) + avg_margins.top-10)
                    .style("stroke", "#d62f2f")
                    .style("stroke-width", 2);

                avgChartArea.append("path")
                    .datum(d3.range(dates.length))
                    .attr("class", "line-chart")
                    .attr("fill", "none")
                    .attr("stroke", "#4a4444")
                    .attr("stroke-width", 1.5)
                    .attr("d", line);

                let circles = avgChartArea.selectAll("circle").data(dates)
                    .join("circle")
                    .attr("class", "point")
                    .attr("cx", d => avgxScale(d))
                    .attr("cy", d => avgyScale(avgBirths[d]-avg_avg))
                    .attr("r", 5)
                    .style("fill", "black")
                    .style("opacity", 0);

                let points = avgChartArea.selectAll(".point");

                points.on("mouseover", function(event, d) {
                    d3.select(this)
                        .style("opacity", 1);
                    avgChartArea.append("rect")
                        .attr("x", -10)
                        .attr("y", 0)
                        .attr("width", 220)
                        .attr("height", 15)
                        .attr("id","rect")
                        .style("fill","white");
                    avgChartArea.append("text")
                        .attr("id", "tooltip")
                        .attr("x", 100)
                        .attr("y", 10)
                        .attr("text-anchor", "middle")
                        .text(`Date: ${d.toLocaleDateString(undefined, {month:'short', day:'numeric'})}, Avg Births: ${Math.round(avgBirths[d])}`)
                });

                points.on("mouseout", function(event, d) {
                    d3.select(this).style("opacity", 0);
                    d3.select("#tooltip").remove();
                    d3.select("#rect").remove();
                });

                //date update
                let avg_date_update = d3.select("#avg_date_update");

                avg_date_update.on("click", function(event, d) {
                    const avgmonthInput = parseInt(document.getElementById("avgmonthInput").value);
                    const avgdayInput = parseInt(document.getElementById("avgdayInput").value);

                    avgChartArea.selectAll(".added-circle").remove();

                    if (!isNaN(avgmonthInput) && !isNaN(avgdayInput)) {
                        highlightSelectedDate_avg(avgmonthInput, avgdayInput);
                    } else if (!isNaN(avgdayInput)) {
                        highlightSelectedDay(avgdayInput);
                    } else {
                        alert("Please enter valid values for month and/or day.");
                    }
                });

                function highlightSelectedDate_avg(month, day) {
                    const matchingDate = dates.find(date => date.getMonth() + 1 === month && date.getDate() === day);
                    if (matchingDate) {
                        console.log(matchingDate);
                        console.log(avgyScale(avgBirths[matchingDate]-avg_avg));
                        avgChartArea.append("circle")
                            .attr("class", "added-circle")
                            .attr("cx", avgxScale(matchingDate))
                            .attr("cy", avgyScale(avgBirths[matchingDate]-avg_avg))
                            .attr("r", 5)
                            .style("fill", "#d62f2f")
                            .style("opacity", 1)
                            .on("mouseover", function(event) {
                                d3.select(this).attr("r", 8);
                                avgChartArea.append("rect")
                                    .attr("x", -8)
                                    .attr("y", 0)
                                    .attr("width", 220)
                                    .attr("height", 17)
                                    .attr("id","rect")
                                    .style("fill","white");
                                avgChartArea.append("text")
                                    .attr("id", "tooltip")
                                    .attr("x", 100)
                                    .attr("y", 10)
                                    .attr("text-anchor", "middle")
                                    .text(`Date: ${matchingDate.toLocaleDateString(undefined, {month:'short', day:'numeric'})}, Avg Births: ${Math.round(avgBirths[matchingDate])}`)
                            }).on("mouseout", function(event) {
                                d3.select(this).attr("r", 5)
                                d3.select("#tooltip").remove();
                                d3.select("#rect").remove();
                            });
                    } else {
                        alert("No data available for the entered date.");
                    }
                }

                function highlightSelectedDay(day) {
                    dates.forEach((date) => {
                        if (date.getDate() === day) {
                            console.log(date);
                            avgChartArea.append("circle")
                                .attr("class", "added-circle")
                                .attr("cx", avgxScale(date))
                                .attr("cy", avgyScale(avgBirths[date]-avg_avg))
                                .attr("r", 5)
                                .style("fill", "#d62f2f")
                                .style("opacity", 1)
                                .on("mouseover", function(event) {
                                    d3.select(this).attr("r", 8);
                                    avgChartArea.append("rect")
                                        .attr("x", -8)
                                        .attr("y", 0)
                                        .attr("width", 220)
                                        .attr("height", 17)
                                        .attr("id","rect")
                                        .style("fill","white");
                                    avgChartArea.append("text")
                                        .attr("id", "tooltip")
                                        .attr("x", 100)
                                        .attr("y", 10)
                                        .attr("text-anchor", "middle")
                                        .text(`Date: ${date.toLocaleDateString(undefined, {month:'short', day:'numeric'})}, Avg Births: ${Math.round(avgBirths[date])}`)
                                }).on("mouseout", function(event) {
                                    d3.select(this).attr("r", 5)
                                    d3.select("#tooltip").remove();
                                    d3.select("#rect").remove();
                                });
                        }
                    });
                }

                // highlighting holidays
                let holidayCheck = d3.select("#holidayCheck");

                holidayCheck.on("click", function(){
                    avgChartArea.selectAll(".added-circle").remove();
                    let checkbox = d3.select(this);
                    if (checkbox.property("checked")){

                        holidays.forEach(holiday => {
                            Object.keys(avgBirths).forEach(d => {
                                const date = new Date(d);
                                if (date.getMonth() + 1 === holiday[0] && date.getDate() === holiday[1]) {
                                    // console.log(d);
                                    // console.log(avgBirths[d]);
                                    avgChartArea.append("circle")
                                        .attr("class", "holiday-circle")
                                        .attr("cx", avgxScale(date))
                                        .attr("cy", avgyScale(avgBirths[d] - avg_avg))
                                        .attr("r", 5)
                                        .style("fill", "#d62f2f")
                                        .style("stroke", "#d62f2f")
                                        .on("mouseover", function(event) {
                                            // console.log(d);
                                            d3.select(this)
                                                .style("opacity", 1);
                                            avgChartArea.append("rect")
                                                .attr("x", -13)
                                                .attr("y", 0)
                                                .attr("width", 220)
                                                .attr("height", 17)
                                                .attr("id","rect")
                                                .style("fill","white");
                                            avgChartArea.append("text")
                                                .attr("id", "tooltip")
                                                .attr("x", 100)
                                                .attr("y", 10)
                                                .attr("text-anchor", "middle")
                                                .text(`Date: ${date.toLocaleDateString(undefined, {month:'short', day:'numeric'})}, Avg Births: ${Math.round(avgBirths[d])}`)
                                        })
                                        .on("mouseout", function(event, d) {
                                            d3.select("#tooltip").remove();
                                            d3.select("#rect").remove();
                                        });
                                }
                            });
                        });

                        avgChartArea.append("text")
                            .attr("class", "holiday-text")
                            .attr("x", 330)
                            .attr("y", 150)
                            .text("Memorial Day")
                        avgChartArea.append("rect")
                            .attr("class", "holiday-rect")
                            .attr("x", 365)
                            .attr("y", 120)
                            .attr("width", 2)
                            .attr("height", 8)
                            .attr("fill", "#d62f2f")
                        avgChartArea.append("rect")
                            .attr("class", "holiday-rect")
                            .attr("x", 365)
                            .attr("y", 128)
                            .attr("width", 30)
                            .attr("height", 2)
                            .attr("fill", "#d62f2f")
                        avgChartArea.append("rect")
                            .attr("class", "holiday-rect")
                            .attr("x", 393)
                            .attr("y", 120)
                            .attr("width", 2)
                            .attr("height", 8)
                            .attr("fill", "#d62f2f")

                        //
                        avgChartArea.append("text")
                            .attr("class", "holiday-text")
                            .attr("x", 600)
                            .attr("y", 120)
                            .text("Labor Day")
                        avgChartArea.append("rect")
                            .attr("class", "holiday-rect")
                            .attr("x", 620)
                            .attr("y", 90)
                            .attr("width", 2)
                            .attr("height", 8)
                            .attr("fill", "#d62f2f")
                        avgChartArea.append("rect")
                            .attr("class", "holiday-rect")
                            .attr("x", 620)
                            .attr("y", 98)
                            .attr("width", 30)
                            .attr("height", 2)
                            .attr("fill", "#d62f2f")
                        avgChartArea.append("rect")
                            .attr("class", "holiday-rect")
                            .attr("x",648)
                            .attr("y", 90)
                            .attr("width", 2)
                            .attr("height", 8)
                            .attr("fill", "#d62f2f")

                        //
                        avgChartArea.append("text")
                            .attr("class", "holiday-text")
                            .attr("x", 800)
                            .attr("y", 195)
                            .text("Thanksgiving")
                        avgChartArea.append("rect")
                            .attr("class", "holiday-rect")
                            .attr("x", 830)
                            .attr("y", 170)
                            .attr("width", 2)
                            .attr("height", 8)
                            .attr("fill", "#d62f2f")
                        avgChartArea.append("rect")
                            .attr("class", "holiday-rect")
                            .attr("x", 830)
                            .attr("y", 178)
                            .attr("width", 30)
                            .attr("height", 2)
                            .attr("fill", "#d62f2f")
                        avgChartArea.append("rect")
                            .attr("class", "holiday-rect")
                            .attr("x",858)
                            .attr("y", 170)
                            .attr("width", 2)
                            .attr("height", 8)
                            .attr("fill", "#d62f2f")
                        //
                        avgChartArea.append("text")
                            .attr("class", "holiday-text")
                            .attr("x", 10)
                            .attr("y", 288)
                            .text("New Year's Day")
                        avgChartArea.append("text")
                            .attr("class", "holiday-text")
                            .attr("x", 50)
                            .attr("y", 30)
                            .text("Valentine's Day")
                        avgChartArea.append("text")
                            .attr("class", "holiday-text")
                            .attr("x", 145)
                            .attr("y", 60)
                            .text("St. Patrick's Day")
                        avgChartArea.append("text")
                            .attr("class", "holiday-text")
                            .attr("x", 262)
                            .attr("y", 60)
                            .text("Cinco De Mayo")
                        avgChartArea.append("text")
                            .attr("class", "holiday-text")
                            .attr("x", 440)
                            .attr("y", 245)
                            .text("July Fourth")
                        avgChartArea.append("text")
                            .attr("class", "holiday-text")
                            .attr("x", 750)
                            .attr("y", 165)
                            .text("Halloween")
                        avgChartArea.append("rect")
                            .attr("class", "holiday-rect")
                            .attr("x", 830)
                            .attr("y", 112)
                            .attr("width", 102)
                            .attr("height", 15)
                            .attr("fill", "white")
                        avgChartArea.append("text")
                            .attr("class", "holiday-text")
                            .attr("x", 830)
                            .attr("y", 125)
                            .text("New Year's Eve")
                        avgChartArea.append("text")
                            .attr("class", "holiday-text")
                            .attr("x", 850)
                            .attr("y", 365)
                            .text("Christmas")
                        avgChartArea.append("text")
                            .attr("class", "holiday-text")
                            .attr("x", 660)
                            .attr("y", 65)
                            .text("9/11")
                        avgChartArea.append("text")
                            .attr("class", "holiday-text")
                            .attr("x", 120)
                            .attr("y", 135)
                            .text("Leap Day")

                    }
                    else {
                        console.log("unchecked")
                        document.querySelectorAll('.holiday-text, .holiday-circle, .holiday-rect').forEach(element => {
                            element.remove();
                        });
                    }
                })
            }

            requestData();




        </script>
    </body>
</html>
